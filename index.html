<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAHAMIN - Simulasi UTBK</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0056b3; --bg: #f4f7f6; --text: #333; --white: #fff; --green: #28a745; --red: #dc3545; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
        body { background:var(--bg); color:var(--text); min-height:100vh; }
        .hidden { display:none !important; }
        
        /* AUTH STYLE */
        #auth-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; backdrop-filter:blur(5px); }
        .auth-box { background:white; padding:2rem; border-radius:12px; width:90%; max-width:400px; box-shadow:0 10px 25px rgba(0,0,0,0.3); }
        .auth-tabs { display:flex; margin-bottom:20px; border-bottom:2px solid #eee; }
        .auth-tabs button { flex:1; padding:12px; background:none; border:none; font-weight:600; color:#aaa; cursor:pointer; border-bottom:3px solid transparent; transition:0.3s; }
        .auth-tabs button.active { color:var(--primary); border-bottom:3px solid var(--primary); }
        .form-group { margin-bottom:15px; }
        .form-group input { width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; }
        .btn-primary { background:var(--primary); color:white; border:none; padding:14px; border-radius:6px; width:100%; font-weight:bold; cursor:pointer; margin-top:10px; }

        /* DASHBOARD STYLE */
        #main-header { background:var(--primary); color:white; padding:1rem; display:flex; justify-content:space-between; align-items:center; position:fixed; top:0; width:100%; z-index:100; }
        #landing-page { margin-top:80px; padding:20px; display:flex; justify-content:center; }
        .mode-card { background:white; padding:20px; border-radius:10px; border:1px solid #eee; margin-bottom:20px; max-width:600px; width:100%; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        
        /* EXAM STYLE */
        #exam-container { margin-top:80px; padding:20px; max-width:800px; margin-left:auto; margin-right:auto; }
        .question-area { background:white; padding:20px; border-radius:10px; margin-bottom:20px; font-size:1.1rem; line-height:1.6; }
        .option { display:flex; gap:10px; padding:15px; border:1px solid #eee; border-radius:8px; margin-bottom:10px; cursor:pointer; }
        .option.selected { background:#eef6ff; border-color:var(--primary); }
        .opt-label { width:25px; height:25px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; font-weight:bold; }
        .option.selected .opt-label { background:var(--primary); color:white; }
        .nav-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; margin-top:10px; }
        .nav-item { padding:10px; background:#fff; border:1px solid #ccc; text-align:center; cursor:pointer; border-radius:4px; font-weight:bold; }
        .nav-item.active { background:var(--primary); color:white; }
        .nav-item.marked { background:#ffc107; color:black; border-color:#e0a800; font-weight:bold; }

        /* REVIEW STYLE (PEMBAHASAN) */
        .review-item { background:white; padding:20px; border-radius:10px; margin-bottom:15px; border-left:5px solid #ccc; text-align:left; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .review-item.correct { border-left-color: var(--green); }
        .review-item.wrong { border-left-color: var(--red); }
        .status-badge { display:inline-block; padding:4px 10px; border-radius:20px; color:white; font-size:0.8rem; font-weight:bold; margin-bottom:10px; }
        .bg-green { background:var(--green); }
        .bg-red { background:var(--red); }
        .explanation-box { background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px; border:1px solid #e9ecef; font-size:0.95rem; line-height:1.5; }
        .explanation-title { font-weight:bold; color:var(--primary); margin-bottom:5px; display:block; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box">
            <h2 style="text-align:center; color:var(--primary); margin-bottom:20px;">Selamat Datang</h2>
            <div class="auth-tabs">
                <button id="tab-login" class="active" onclick="switchMode('login')">Masuk</button>
                <button id="tab-register" onclick="switchMode('register')">Daftar</button>
            </div>
            <div id="form-login">
                <div class="form-group"><input type="email" id="l-email" placeholder="Email"></div>
                <div class="form-group"><input type="password" id="l-password" placeholder="Password"></div>
                <button class="btn-primary" onclick="doLogin()">MASUK</button>
            </div>
            <div id="form-register" class="hidden">
                <div class="form-group"><input type="text" id="r-name" placeholder="Nama"></div>
                <div class="form-group"><input type="email" id="r-email" placeholder="Email"></div>
                <div class="form-group"><input type="password" id="r-password" placeholder="Password"></div>
                <button class="btn-primary" onclick="doRegister()">DAFTAR</button>
            </div>
        </div>
    </div>

    <header id="main-header" class="hidden">
        <div style="font-weight:bold;">PAHAMIN - UTBK 2026</div>
        <div style="text-align:right;"><div id="u-name" style="font-size:0.9rem;">User</div><div onclick="logout()" style="font-size:0.7rem; cursor:pointer;">Keluar</div></div>
    </header>

    <div id="landing-page" class="hidden">
        <div style="width:100%; max-width:600px;">
            <div class="mode-card">
                <h3>A. Latihan Per Subtes</h3>
                <p style="color:#666; font-size:0.9rem; margin:5px 0 15px;">Waktu & Jumlah Soal disesuaikan standar UTBK</p>
                <select id="mapel" style="width:100%; padding:12px; margin-bottom:15px; border-radius:6px; border:1px solid #ccc;">
                    <optgroup label="TPS - Penalaran Umum">
                        <option value="Penalaran Induktif">Penalaran Induktif (10 Soal - 10 Menit)</option>
                        <option value="Penalaran Deduktif">Penalaran Deduktif (10 Soal - 10 Menit)</option>
                        <option value="Penalaran Kuantitatif">Penalaran Kuantitatif (10 Soal - 10 Menit)</option>
                    </optgroup>
                    <optgroup label="TPS - Pemahaman">
                        <option value="Pengetahuan & Pemahaman Umum">Pengetahuan & Pemahaman Umum (20 Soal - 15 Menit)</option>
                        <option value="Pemahaman Bacaan & Menulis">Pemahaman Bacaan & Menulis (20 Soal - 25 Menit)</option>
                        <option value="Pengetahuan Kuantitatif">Pengetahuan Kuantitatif (20 Soal - 20 Menit)</option>
                    </optgroup>
                    <optgroup label="Literasi & Penalaran Matematika">
                        <option value="Literasi Bahasa Indonesia">Literasi Bahasa Indonesia (30 Soal - 42.5 Menit)</option>
                        <option value="Literasi Bahasa Inggris">Literasi Bahasa Inggris (20 Soal - 20 Menit)</option>
                        <option value="Penalaran Matematika">Penalaran Matematika (20 Soal - 42.5 Menit)</option>
                    </optgroup>
                </select>
                <button id="btn-practice" class="btn-primary" onclick="startExam('practice')">Mulai Latihan</button>
            </div>
            
            <div class="mode-card" style="border:2px solid var(--primary); background:#f0f7ff;">
                <h3 style="color:var(--primary);">B. Simulasi Full UTBK</h3>
                <p style="color:#666; font-size:0.9rem; margin:5px 0 15px;">Semua Subtes | 195 Menit</p>
                <button id="btn-full" class="btn-primary" onclick="startExam('full')">Mulai Simulasi Full (180 Soal)</button>
            </div>
        </div>
    </div>

    <div id="exam-container" class="hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; background:white; padding:15px; border-radius:8px;">
            <b id="exam-title">Ujian</b>
            <b id="timer" style="color:red; font-size:1.2rem;">00:00:00</b>
        </div>
        <div id="question-box" class="question-area">Loading...</div>
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <button onclick="navQ(-1)" style="padding:10px 20px;">‚ùÆ Sblm</button>
            <button onclick="toggleMark()" style="padding:10px 20px; background:#ffc107; color:black; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">üìå Ragu-Ragu</button>
            <button onclick="navQ(1)" style="padding:10px 20px;">Lanjut ‚ùØ</button>
        </div>
        <div style="background:white; padding:15px; border-radius:8px;">
            <div id="nav-grid" class="nav-grid"></div>
            <button class="btn-primary" style="background:#dc3545; margin-top:20px;" onclick="submitExam()">SELESAI</button>
        </div>
    </div>

    <div id="result-page" class="hidden" style="margin-top:100px; text-align:center; padding-bottom:50px;">
        <div style="width:100%; max-width:800px; margin:0 auto;">
            <div class="mode-card">
                <h1>Skor Kamu</h1>
                <h2 id="final-score" style="font-size:3.5rem; color:var(--primary); margin:20px 0;">0</h2>
                <p id="final-msg" style="margin-bottom:20px;"></p>
                <button class="btn-primary" onclick="location.reload()">Kembali ke Menu</button>
            </div>
            <div style="margin-top:30px; text-align:left;">
                <h3 style="margin-bottom:15px;">Pembahasan & Kunci Jawaban</h3>
                <div id="review-list"></div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG & STATE
        const STORAGE_KEY = 'pahamin_progress_v1'; // Kunci untuk Auto-Save
        const examRules = {
            "Penalaran Induktif": { limit: 10, time: 10 * 60 },
            "Penalaran Deduktif": { limit: 10, time: 10 * 60 },
            "Penalaran Kuantitatif": { limit: 10, time: 10 * 60 },
            "Pengetahuan & Pemahaman Umum": { limit: 20, time: 15 * 60 },
            "Pemahaman Bacaan & Menulis": { limit: 20, time: 25 * 60 },
            "Pengetahuan Kuantitatif": { limit: 20, time: 20 * 60 },
            "Literasi Bahasa Indonesia": { limit: 30, time: 42.5 * 60 },
            "Literasi Bahasa Inggris": { limit: 20, time: 20 * 60 },
            "Penalaran Matematika": { limit: 20, time: 42.5 * 60 }
        };
        
        let questions = [], answers = [], marked = [], idx = 0, timerVal;
        let examStartTime = 0; // Untuk timer anti-reset

        // --- AUTH SYSTEM ---
        function switchMode(m) {
            document.getElementById('form-login').classList.toggle('hidden', m !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', m !== 'register');
            document.getElementById('tab-login').classList.toggle('active', m === 'login');
            document.getElementById('tab-register').classList.toggle('active', m === 'register');
        }
        async function doLogin() {
            const email = document.getElementById('l-email').value;
            localStorage.setItem('user', JSON.stringify({name:"Peserta", email}));
            showDash({name:"Peserta"});
        }
        function doRegister() { alert("Daftar Sukses!"); switchMode('login'); }
        function showDash(u) {
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('landing-page').classList.remove('hidden');
            document.getElementById('u-name').innerText = u.name;
            
            // Cek apakah ada progress tersimpan
            setTimeout(loadProgress, 500); 
        }
        function logout() { localStorage.clear(); location.reload(); }
        if(localStorage.getItem('user')) showDash(JSON.parse(localStorage.getItem('user')));

        // --- CORE EXAM FUNCTIONS ---
        async function startExam(mode) {
            // Bersihkan data lama dulu biar fresh
            localStorage.removeItem(STORAGE_KEY);
            
            const btn = document.getElementById(mode === 'practice' ? 'btn-practice' : 'btn-full');
            const cat = document.getElementById('mapel').value;
            if(btn) btn.innerText = "Menyiapkan Soal...";

            let limit = 20, duration = 20 * 60;
            if (mode === 'practice' && examRules[cat]) {
                limit = examRules[cat].limit;
                duration = examRules[cat].time;
            } else if (mode === 'full') {
                limit = 180; 
                duration = 195 * 60;
            }

            let url = `/api/questions?mode=${mode}&limit=${limit}`;
            if(mode === 'practice') url += `&category=${encodeURIComponent(cat)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                questions = (data && data.length > 0) ? data : [{question:"Data kosong.", options:{A:"-"}, correct:"A"}];
                answers = new Array(questions.length).fill(null);
                marked = new Array(questions.length).fill(false);
                idx = 0;
                examStartTime = Date.now(); // Catat waktu mulai

                setupExamUI(mode === 'full' ? "Simulasi Full" : cat);
                saveProgress(duration); // Simpan progress awal
                startTimer(duration);
            } catch(e) { 
                alert("Gagal koneksi server. Pastikan 'node api/index.js' jalan."); 
                if(btn) btn.innerText = "Mulai"; 
            }
        }

        function setupExamUI(title) {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('exam-container').classList.remove('hidden');
            document.getElementById('exam-title').innerText = title;
            renderQ(); 
            renderNav();
        }

        function renderQ() {
            const q = questions[idx];
            let h = `<p style="margin-bottom:20px;"><b>No ${idx+1}.</b> ${q.question || q.text}</p>`;
            ['A','B','C','D','E'].forEach(opt => {
                if(q.options[opt]) {
                    const sel = answers[idx] === opt ? 'selected' : '';
                    h += `<div class="option ${sel}" onclick="pilih('${opt}')"><div class="opt-label">${opt}</div><div>${q.options[opt]}</div></div>`;
                }
            });
            document.getElementById('question-box').innerHTML = h;
            renderNav();
        }

        function pilih(opt) {
            answers[idx] = opt;
            renderQ();
            saveProgress(); // AUTO-SAVE SETIAP PILIH JAWABAN
        }

        function toggleMark() {
            marked[idx] = !marked[idx];
            renderNav();
            saveProgress(); // AUTO-SAVE STATUS MARK
        }
        
        function navQ(d) { 
            if(idx+d >= 0 && idx+d < questions.length) { 
                idx += d; 
                renderQ(); 
                saveProgress(); // AUTO-SAVE SETIAP PINDAH SOAL
            } 
        }

        function renderNav() {
            const g = document.getElementById('nav-grid'); g.innerHTML = '';
            questions.forEach((_, i) => {
                const d = document.createElement('div');
                const classes = [`nav-item`, idx===i?'active':'', answers[i]?'answered':'', marked[i]?'marked':''].filter(c=>c);
                d.className = classes.join(' ');
                d.innerText = i+1;
                d.onclick = () => { idx=i; renderQ(); saveProgress(); };
                g.appendChild(d);
            });
        }

        function startTimer(s) {
            const el = document.getElementById('timer'); 
            clearInterval(timerVal);
            
            // Hitung target waktu selesai (biar sinkron kalau di-refresh)
            let endTime = Date.now() + (s * 1000);
            
            // Kalau ini load dari save-an, pakai sisa waktu yang benar
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                const d = JSON.parse(saved);
                if(d.endTime) endTime = d.endTime; // Pakai target waktu yang lama
                else {
                    // Kalau data lama belum punya endTime, update
                    d.endTime = endTime;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
                }
            }

            timerVal = setInterval(() => {
                const now = Date.now();
                let diff = Math.ceil((endTime - now) / 1000); // Sisa detik
                
                if (diff <= 0) { 
                    clearInterval(timerVal); 
                    submitExam(); 
                    return;
                }

                let m = Math.floor(diff/60), sec = Math.floor(diff%60);
                let h = Math.floor(m/60); m = m%60;
                el.innerText = `${h}:${m<10?'0'+m:m}:${sec<10?'0'+sec:sec}`;
            }, 1000);
        }

        // --- FITUR ANTI-RESET (LOGIC UTAMA) ---
        function saveProgress(initialDuration = 0) {
            const data = {
                questions: questions,
                answers: answers,
                marked: marked,
                idx: idx,
                title: document.getElementById('exam-title').innerText,
                // Simpan endTime agar timer akurat
                endTime: initialDuration ? (Date.now() + initialDuration * 1000) : null 
            };
            
            // Jika sudah ada endTime sebelumnya, jangan ditimpa (pakai yang lama)
            const old = localStorage.getItem(STORAGE_KEY);
            if(old) {
                const oldData = JSON.parse(old);
                if(oldData.endTime) data.endTime = oldData.endTime;
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            try {
                const d = JSON.parse(saved);
                // Cek apakah masih ada waktu?
                if(d.endTime && d.endTime < Date.now()) {
                    localStorage.removeItem(STORAGE_KEY); // Waktu habis, hapus
                    return;
                }

                if (confirm(`‚ö†Ô∏è Terdeteksi sesi ujian "${d.title}" yang belum selesai.\n\nKlik OK untuk MELANJUTKAN.\nKlik Cancel untuk MULAI BARU.`)) {
                    questions = d.questions;
                    answers = d.answers;
                    marked = d.marked || new Array(questions.length).fill(false);
                    idx = d.idx;
                    setupExamUI(d.title);
                    
                    // Lanjutkan timer berdasarkan selisih waktu
                    const sisaDetik = Math.ceil((d.endTime - Date.now()) / 1000);
                    startTimer(sisaDetik);
                } else {
                    localStorage.removeItem(STORAGE_KEY);
                }
            } catch(e) { console.error(e); localStorage.removeItem(STORAGE_KEY); }
        }

        function submitExam() {
            if(!confirm("Yakin selesai mengerjakan?")) return;
            clearInterval(timerVal);
            
            // HAPUS SAVE-AN KARENA SUDAH SELESAI
            localStorage.removeItem(STORAGE_KEY);

            let correctCount = 0;
            let reviewHTML = "";

            questions.forEach((q, i) => {
                const myAns = answers[i] || "-";
                const isCorrect = myAns === q.correct;
                if(isCorrect) correctCount++;

                reviewHTML += `
                    <div class="review-item ${isCorrect ? 'correct' : 'wrong'}">
                        <div style="display:flex; justify-content:space-between;"><b>Soal No ${i+1}</b> <span class="status-badge ${isCorrect ? 'bg-green' : 'bg-red'}">${isCorrect ? 'BENAR' : 'SALAH'}</span></div>
                        <p style="margin:10px 0;">${q.question}</p>
                        <div style="font-size:0.9rem;">Jawaban Kamu: <b>${myAns}</b> ${!isCorrect ? `| Kunci: <b>${q.correct}</b>` : ''}</div>
                        <div class="explanation-box"><span class="explanation-title">üí° Pembahasan:</span>${q.explanation || "-"}</div>
                    </div>
                `;
            });

            document.getElementById('exam-container').classList.add('hidden');
            document.getElementById('result-page').classList.remove('hidden');
            document.getElementById('final-score').innerText = Math.round((correctCount/questions.length)*1000);
            document.getElementById('final-msg').innerText = `Benar ${correctCount} dari ${questions.length} soal.`;
            document.getElementById('review-list').innerHTML = reviewHTML;
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>